{% extends "psf/full-width.html" %}
{% load boxes %}

{% block page_title %}Sponsorship Application | {{ SITE_INFO.site_name }}{% endblock %}

{% block content %}

    <article class="text">
        <h1>Form </h1>
        <form id="application_form" action="." method="POST">
          {% csrf_token %}

          {% if form.errors %}
            {{ form.non_field_errors }}
          {% endif %}

          {{ form.package }}

          <button type="button" id="clear_form_btn" name="clear">Clear Selections</button>

          <div id="benefits_container">
          {% for field in form.benefits_programs %}
            {{ field.label }}
            {{ field }}
          {% endfor %}
          </div>

          <div id="cost_container" calculate_cost_url="{% url 'new_sponsorship_application_price_calc' %}">
            <span id="cost_label"></span>
          </div>

          <input type="submit" value="Submit">
          </div>
        </form>
    </article>

    <div id="package_benefits" style="display: none">
    {% for package, benefits in form.benefits_by_package.items %}
      <div id="package_benefits_{{ package }}">
        {% for benefit in benefits %}
          <div>{{ benefit }}</div>
        {% endfor %}
      </div>
    {% endfor %}
    </div>

    <div id="conflicts_container" style="display: none">
    {% for benefit, conflicts in form.benefits_conflicts.items %}
      <div id="conflicts_with_{{ benefit }}">
        {% for conflict in conflicts %}
          <div>{{ conflict }}</div>
        {% endfor %}
      </div>
    {% endfor %}
    </div>
{% endblock content %}

{% block javascript %}
  {{ block.super }}
  <script type="text/javascript">
  /// TODO move this script to a proper JS file
  $(document).ready(function(){
      let checkboxesContainer = $('#benefits_container');
      $("#clear_form_btn").click(function(){
          $("#application_form").trigger("reset");
      })

      $("input[name=package]").change(function(){
        let package = this.value;
        if (package.length == 0) return;

        checkboxesContainer.find(':checkbox').each(function(){
            $(this).prop('checked', false);
        });

        $("#package_benefits_" + package).children().each(function(){
            let benefit = $(this).html()
            checkboxesContainer.find(`[value=${benefit}]`).prop("checked", true);
        });
      });

      $("input[id^=id_benefits_]").change(function(){
        let benefit = this.value;
        if (benefit.length == 0) return;

        let active = checkboxesContainer.find(`[value=${benefit}]`).prop("checked");
        if (!active) return;

        $(`#conflicts_with_${benefit}`).children().each(function(){
            let conflict = $(this).html()
            checkboxesContainer.find(`[value=${conflict}]`).prop("checked", false);
        });

      });

      $("#application_form").change(function(){
        let url = $("#cost_container").attr("calculate_cost_url");
        let data = $(this).serialize();

        $.get(url, data).done(function(data){
            let cost = data.cost;
            $("#cost_label").html(`Sponsorship cost is $${cost}.00`)
        })
      });
  });
  </script>
{% endblock %}
